# 1. ë“œë¼ì´ë¸Œ ë§ˆìš´íŠ¸
from google.colab import drive
drive.mount('/content/drive')

# 2. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ import
import zipfile
import os

# 3. ì••ì¶• í•´ì œ í•¨ìˆ˜
def unzip_file(zip_path, extract_to):
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_to)
    print(f"âœ… ì••ì¶• í•´ì œ ì™„ë£Œ: {zip_path}")

# 4. ê²½ë¡œ ì„¤ì •
base_path = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)'

# Training ë¼ë²¨ë§ ë°ì´í„° ê²½ë¡œ
train_label_folder = os.path.join(base_path, '01.ë°ì´í„°/Training/ë¼ë²¨ë§ë°ì´í„°')
train_label_extract_folder = os.path.join(base_path, '01.ë°ì´í„°/Training/ë¼ë²¨ë§ë°ì´í„°_extracted')

# Training ì›ì²œ ë°ì´í„° ê²½ë¡œ
train_origin_folder = os.path.join(base_path, '01.ë°ì´í„°/Training/ì›ì²œë°ì´í„°')

# Validation ë¼ë²¨ë§ ë°ì´í„° ê²½ë¡œ
val_label_folder = os.path.join(base_path, '01.ë°ì´í„°/Validation/ë¼ë²¨ë§ë°ì´í„°')

# Validation ì›ì²œ ë°ì´í„° ê²½ë¡œ
val_origin_folder = os.path.join(base_path, '01.ë°ì´í„°/Validation/ì›ì²œë°ì´í„°')

# 5. Training - ë¼ë²¨ë§ë°ì´í„° ì••ì¶• í•´ì œ
os.makedirs(train_label_extract_folder, exist_ok=True)
unzip_file(os.path.join(train_label_folder, 'TL1_CAT.zip'), train_label_extract_folder)
unzip_file(os.path.join(train_label_folder, 'TL2_DOG.zip'), train_label_extract_folder)

# 6. Training - ì›ì²œë°ì´í„° ì••ì¶• í•´ì œ
unzip_file(os.path.join(train_origin_folder, 'TS1_CAT.zip'), train_origin_folder)
unzip_file(os.path.join(train_origin_folder, 'TS2_DOG.zip'), train_origin_folder)

# 7. Validation - ë¼ë²¨ë§ë°ì´í„° ì••ì¶• í•´ì œ
unzip_file(os.path.join(val_label_folder, 'VL1_CAT.zip'), val_label_folder)
unzip_file(os.path.join(val_label_folder, 'VL2_DOG.zip'), val_label_folder)

# 8. Validation - ì›ì²œë°ì´í„° ì••ì¶• í•´ì œ
unzip_file(os.path.join(val_origin_folder, 'VS1_CAT.zip'), val_origin_folder)
unzip_file(os.path.join(val_origin_folder, 'VS2_DOG.zip'), val_origin_folder)




# 1. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ import
import os
import json
from PIL import Image

# 2. ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
base_path = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)'

# 3. ê²½ë¡œ ì„¸íŒ…
sets = {
    'train': {
        'json_folder': os.path.join(base_path, "01.ë°ì´í„°/Training/ë¼ë²¨ë§ë°ì´í„°_extracted"),  # â˜… ì••ì¶• í‘¼ ë¼ë²¨ ê²½ë¡œ ì£¼ì˜!
        'image_folder': os.path.join(base_path, "01.ë°ì´í„°/Training/ì›ì²œë°ì´í„°"),
        'output_folder': os.path.join(base_path, "01.ë°ì´í„°/Training/labels")
    },
    'val': {
        'json_folder': os.path.join(base_path, "01.ë°ì´í„°/Validation/ë¼ë²¨ë§ë°ì´í„°"),  # Validationì€ ë³„ë„ ì••ì¶• ì•ˆ í–ˆìœ¼ë©´ ì›ë˜ ê²½ë¡œ
        'image_folder': os.path.join(base_path, "01.ë°ì´í„°/Validation/ì›ì²œë°ì´í„°"),
        'output_folder': os.path.join(base_path, "01.ë°ì´í„°/Validation/labels")
    }
}

# 4. ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í™•ì¥ì
image_exts = ['.jpg', '.jpeg', '.png']

# 5. ë³€í™˜ í•¨ìˆ˜ ì •ì˜
def convert_to_yolo(json_folder, image_folder, output_folder):
    os.makedirs(output_folder, exist_ok=True)

    for file in os.listdir(json_folder):
        if file.endswith('.json'):
            base_name = os.path.splitext(file)[0]
            json_path = os.path.join(json_folder, file)
            print(f"ğŸš§ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ JSON íŒŒì¼: {json_path}")  # ì¶”ê°€ëœ ì½”ë“œ

            # JSON ë¡œë“œ
            try:
                with open(json_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
            except json.JSONDecodeError as e:
                print(f"âŒ JSON ë””ì½”ë“œ ì—ëŸ¬ ë°œìƒ: {json_path} - {e}")
                continue  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ìŒ íŒŒì¼ë¡œ ê±´ë„ˆë›°ê¸°

            # ì´ë¯¸ì§€ ì°¾ê¸°
            image_path = None
            for ext in image_exts:
                candidate = os.path.join(image_folder, base_name + ext)
                if os.path.exists(candidate):
                    image_path = candidate
                    break

            if not image_path:
                print(f"âš ï¸ ì´ë¯¸ì§€ ì—†ìŒ: {base_name}")
                continue

            # ì´ë¯¸ì§€ í¬ê¸° ì–»ê¸°
            with Image.open(image_path) as img:
                img_width, img_height = img.size

            # YOLO í¬ë§· ë§Œë“¤ê¸°
            yolo_lines = []
            for ann in data.get("annotations", []):
                if ann.get("shape") == "Bounding Box":
                    (x1, y1), (x2, y2) = ann["points"]
                    cx = (x1 + x2) / 2 / img_width
                    cy = (y1 + y2) / 2 / img_height
                    w = abs(x2 - x1) / img_width
                    h = abs(y2 - y1) / img_height
                    yolo_lines.append(f"0 {cx:.6f} {cy:.6f} {w:.6f} {h:.6f}")

            # ì €ì¥
            out_path = os.path.join(output_folder, base_name + ".txt")
            with open(out_path, "w", encoding='utf-8') as f:
                f.write("\n".join(yolo_lines))

            print(f"âœ… ë³€í™˜ ì™„ë£Œ: {base_name}.txt")

# 6. ë³€í™˜ ì‹¤í–‰
for phase, paths in sets.items():
    print(f"\nğŸ“‚ ì²˜ë¦¬ ì‹œì‘: {phase}")
    convert_to_yolo(paths['json_folder'], paths['image_folder'], paths['output_folder'])






# 1. train/val ì´ë¯¸ì§€ ê²½ë¡œ ì •ë¦¬
def make_dataset_txt(image_folder, save_txt_path):
    # ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í™•ì¥ì
    image_exts = ['.jpg', '.jpeg', '.png']

    img_paths = []
    for file in os.listdir(image_folder):
        if any(file.endswith(ext) for ext in image_exts):
            full_path = os.path.join(image_folder, file)
            img_paths.append(full_path)

    img_paths.sort()  # (ì„ íƒ) ì•ŒíŒŒë²³ ìˆœìœ¼ë¡œ ì •ë ¬
    print(f"âœ… ì´ {len(img_paths)}ê°œ íŒŒì¼ ê¸°ë¡: {save_txt_path}")

    # txtë¡œ ì €ì¥
    with open(save_txt_path, 'w') as f:
        for path in img_paths:
            f.write(path + '\n')

# 2. ê²½ë¡œ ì„¤ì •
train_image_folder = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/01.ë°ì´í„°/Training/ì›ì²œë°ì´í„°'
val_image_folder = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/01.ë°ì´í„°/Validation/ì›ì²œë°ì´í„°'

# ì €ì¥í•  txt ê²½ë¡œ
train_txt_path = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/train.txt'
val_txt_path = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/val.txt'

# 3. ì‹¤í–‰
make_dataset_txt(train_image_folder, train_txt_path)
make_dataset_txt(val_image_folder, val_txt_path)





import yaml

# 1. YAML íŒŒì¼ì„ ìƒì„±í•  ë°ì´í„° ì„¤ì •
yaml_data = {
    'train': {
        'image_folder': train_image_folder,
        'label_folder': '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/01.ë°ì´í„°/Training/labels',
        'dataset_txt': train_txt_path
    },
    'val': {
        'image_folder': val_image_folder,
        'label_folder': '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/01.ë°ì´í„°/Validation/labels',
        'dataset_txt': val_txt_path
    }
}

# 2. YAML íŒŒì¼ ê²½ë¡œ ì„¤ì •
yaml_file_path = '/content/drive/MyDrive/062.ë°˜ë ¤ë™ë¬¼ ì§ˆë³‘ ì§„ë‹¨ì„ ìœ„í•œ ì˜ìƒ ë°ì´í„° (ê·¼ê³¨ê²©ê³„)/dataset_config.yaml'

# 3. YAML íŒŒì¼ ìƒì„±
with open(yaml_file_path, 'w') as yaml_file:
    yaml.dump(yaml_data, yaml_file, default_flow_style=False, allow_unicode=True)

print(f"âœ… YAML íŒŒì¼ ìƒì„± ì™„ë£Œ: {yaml_file_path}")


import cv2
import numpy as np
from matplotlib import pyplot as plt

# 1. YOLO ëª¨ë¸ íŒŒì¼ ê²½ë¡œ
weights_path = '/path/to/yolov5/weights/file.pt'
config_path = '/path/to/yolov5/config/file.cfg'
class_names = ['class1', 'class2', 'class3']  # ë‹¤ì¹œ ë¶€ìœ„ë¥¼ í¬í•¨í•œ í´ë˜ìŠ¤ ì´ë¦„

# 2. YOLO ëª¨ë¸ ë¡œë“œ (PyTorch ëª¨ë¸ ì˜ˆì‹œ)
import torch

# YOLOv5 ëª¨ë¸ ë¡œë“œ (PyTorch Hub ì‚¬ìš©)
model = torch.hub.load('ultralytics/yolov5', 'custom', path=weights_path)

# 3. ì´ë¯¸ì§€ ë¡œë“œ
image_path = '/path/to/image.jpg'
image = cv2.imread(image_path)

# 4. YOLO ëª¨ë¸ë¡œ ì˜ˆì¸¡
results = model(image)

# 5. ê²°ê³¼ì—ì„œ ë‹¤ì¹œ ë¶€ìœ„ (ì˜ˆ: 'injury' í´ë˜ìŠ¤)ë¥¼ ì°¾ê³  ì´ë¯¸ì§€ì— í‘œì‹œ
# ì˜ˆì‹œ: íŠ¹ì • í´ë˜ìŠ¤ IDë¡œ ê²°ê³¼ë¥¼ í•„í„°ë§
for result in results.xyxy[0]:  # ê²°ê³¼ì—ì„œ bounding box
    x1, y1, x2, y2, conf, cls = result[:6]
    label = class_names[int(cls)]

    # ë‹¤ì¹œ ë¶€ìœ„ë¡œ ì¸ì‹ëœ ê²½ìš° (ì˜ˆ: 'injury' í´ë˜ìŠ¤)
    if label == 'injury':  # 'injury'ëŠ” ë‹¤ì¹œ ë¶€ìœ„ì— í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤
        # Bounding box ê·¸ë¦¬ê¸°
        color = (255, 0, 0)  # ë¹¨ê°„ìƒ‰ ë°•ìŠ¤
        cv2.rectangle(image, (int(x1), int(y1)), (int(x2), int(y2)), color, 2)
        cv2.putText(image, label, (int(x1), int(y1)-10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, color, 2)

# 6. ê²°ê³¼ ì´ë¯¸ì§€ ì¶œë ¥
plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
plt.show()









